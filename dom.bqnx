rxâ†â€¢Import "rx.bqn"
âŸ¨_ForEachâŸ©â†rx

# Maybe define a narrower api as a system function that could be cross-platform...
# - createNode
# - setNodeAttribute
# - setNodeData
# - isNode
# - event target (node)
# 	- different from normal node interface maybe???
# - event value (something reasonable for each event kind)
# 	-there are only 45 different event kinds...
# 

# TODO: GC???
parseFloat     â† â€¢JS "s => (s.join?parseFloat(s.join('')):Number(s))"
createElementâ€¿setAttributeâ€¿appendChildâ€¿createTextNodeâ€¿setTextâ€¿isDomNodeâ†â€¢JS âˆ¾âŸ¨"(() => {const m=_js_obj_reg;let i = 0; const p = x => (m.set(++i,x),i); const g = i => m.get(i); const j=s=>s.join?s.join(''):(s+''); return["
	"tag => p(document.createElement(tag.join(''))),"
	"([k,v], n) => {"
	# Special case: $ prefix for JS properties
	"	if(k[0] == '$') g(n)[j(k).substring(1)]=j(v);"
	"	else g(n).setAttribute(j(k), j(v));"
	"	return n;"
	"},"
	"(nc, np) => (g(np).appendChild(g(nc)),nc),"
	"txt => p(document.createTextNode(j(txt))),"
	"(n, txt) => ((g(n).data=j(txt)), n),"
	"n => g(n) instanceof Node ? 1 : 0,"
"]})()"âŸ©

# TODO next -- make text work correctly...
# TODO fix events too
callbackCounterâ†0
SetAttributeOrListener â† {n ğ•Š kâ€¿v : {
	"on"â‰¡2â†‘k ?
		nameâ†"window._cb_" âˆ¾ â€¢Repr (callbackCounter+â†©1)
		setCbâ†â€¢JS "v => "âˆ¾nameâˆ¾"=v"
		SetCb v
		n SetAttribute âŸ¨k, nameâˆ¾"(event.target.value)"âŸ© # TODO: Support more events!
	; n SetAttribute kâ€¿v
}}

RenderTextNodeâ†{
	nâ†CreateTextNode ""
	SetTextâŸœn _ForEach ğ•©
	n
}

# TODO
# - move to js
# - attr functoins
# - @ means omit attr

Renderâ‡{ğ•Š it: {
 		IsDomNode    it ? it ;
		# TODO: Promise support obvi needs to be more general!
		{ğ•©.thenâ‹„1}âŠ{âˆ§Â´ğ•©>@}âŠ(0Ë™) it ? RenderTextNode it ;

	attrsâ€¿tagâ€¿childrenâ†it
	nâ†CreateElement tag
	{ğ•Š nameâ€¿v :
		nâŠ¸SetAttributeOrListener _ForEach nameâŠ¸â‹ˆá´— v # TODO or listener
	}Â¨attrs
	renderedâ†RenderÂ¨children
	nâŠ¸AppendChildÂ¨rendered # TODO streams, flatten
	n
}}
Listenerâ†{ğ•Š evt:
	listen â† @
	stream â† rx.Signal {{ ğ•Š pushâ€¿close :
		Listenâ†©{ ğ•Š attrsâ€¿tagâ€¿children :
			attrsâˆ¾â†©âŸ¨("on"âˆ¾evt)â€¿pushâŸ© # Renderer responsible for interpreting 
			# TODO: When node is deleted, unlisten and close
			attrsâ€¿tagâ€¿children
		}
	}}
	streamâ€¿listen
}âš‡1
ChangeListenerâ†{ğ•Š eâ€¿L: 
	# TODO gode golf with "under first" or whatever
	# TODO needs to prepend "value" attribute first..?
	eâ€¿L
}âˆ˜(ListenerâŸœ"change")
ChangeListenerâ†©{ğ•¤â‹„Listener "change"}


Div   â†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"div"â€¿ğ•©   } # TODO simplify...
T     â†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"#text"â€¿ğ•© } # TODO:?
Buttonâ†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"button"â€¿ğ•©}
Form  â†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"form"â€¿ğ•©  }
Label â†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"label"â€¿ğ•© }
Selectâ†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"select"â€¿ğ•©}
Optionâ†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"option"â€¿ğ•©}
Input â†{ğ•Šğ•©: âŸ¨âŸ©ğ•Šğ•© ; ğ•¨ğ•Šğ•©: ğ•¨â€¿"input"â€¿ğ•© }

### Examples ###
# TODO move these to other files...
Counterâ‡{ğ•¤â‹„
	eâ€¿Lâ†Listener "click" # e is an event stream and L attaches it to an element
	bumpâ†L Button âŸ¨"Click me!"âŸ©
	# ğ”½â‚ is async scan, ğ”½á´— is async each. Here the same button is shown 3 times.
	Div âŸ¨ Div âŸ¨ 0+â‚1á´—e, " total clicks"âŸ©âŸ©âˆ¾bumpÂ¨â†•3
}

Temperatureâ‡{ğ•¤â‹„
	âŸ¨fInâ€¿LF, cInâ€¿LCâŸ©â†ChangeListenerÂ¨â†•2
	Tempâ†{âŸ¨"type"â€¿"number", "$value"â€¿ğ•©âŸ© Input âŸ¨âŸ©} # '$' indicates JS prop
	# ğ”½â‚Š, "_Bind" uses function inverses to do two-way data binding.
	# âŒ¹, "Cons", is used to add the initial value of 0Â°C
	fâ€¿câ†TempÂ¨ Ã—âŸœ(5Ã·9)âˆ˜(-âŸœ32)â‚ŠÂ´ ParseFloatá´—Â¨âŸ¨fIn, "0" âŒ¹ cInâŸ©
	Div âŸ¨LF f, "Â°F = ", LC c, "Â°C"âŸ©
}

# This does not work yet
Bookerâ†{ğ•¤â‹„
	âŸ¨optâ€¿LOpt, startâ€¿LStart, returnâ€¿LReturnâŸ©â†ChangeListenerÂ¨â†•3
	noReturnâ†"true"âŒ¹{âŠ‘âŸœâŸ¨@â€¿"true"âŸ© "1"â‰¡ğ•©.target.value}á´—opt
	Form DivË˜âŸ¨
		LOpt âŸ¨âŸ© Select âŸ¨
			âŸ¨"value"â€¿"0", "selected"â€¿"true"âŸ© Option "one-way flight"
			âŸ¨"value"â€¿"1"                   âŸ© Option "return flight"
		âŸ©
		LStart  âŸ¨"type"â€¿"date"                     âŸ© Input âŸ¨âŸ©
		LReturn âŸ¨"type"â€¿"date", "disabled"â€¿noReturnâŸ© Input âŸ¨âŸ©
	âŸ©
}

Mainâ‡{ğ•¤â‹„
	Render Temperature @
}
